Project LibraLink {
  database_type: 'PostgreSQL'
  Note: 'Libra Link MVP database schema from PRD v1.2. DBML is canonical design; some Postgres-specific constraints/indexes are captured in notes for migration implementation.'
}

Enum ebook_format {
  epub
  pdf
  txt
}

Enum reading_mode {
  normal
  zen
}

Enum theme_mode {
  light
  dark
  sepia
  high_contrast
}

Enum typography_profile {
  compact
  comfortable
  large
}

Enum share_visibility {
  public
  unlisted
}

Enum share_status {
  active
  disabled
  removed
}

Enum borrow_status {
  active
  returned
  expired
  revoked
}

Enum report_reason {
  copyright
  abuse
  spam
  other
}

Enum report_status {
  open
  in_review
  resolved
  rejected
}

Enum sync_entity_type {
  progress
  annotation
  bookmark
  preference
  reader_state
}

Enum sync_operation {
  upsert
  delete
}

Table users {
  id uuid [pk, not null, default: `uuid_generate_v4()`]
  email text [not null]
  username text [not null]
  password_hash text
  google_id text
  is_admin boolean [not null, default: false]
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]
  email_verified_at timestamptz
  last_login_at timestamptz
  deleted_at timestamptz

  indexes {
    (email) [name: 'idx_users_email_active', unique, note: 'Partial unique index where deleted_at IS NULL']
    (username) [name: 'idx_users_username_active', unique, note: 'Partial unique index where deleted_at IS NULL']
    (google_id) [name: 'idx_users_google_id_active', unique, note: 'Partial unique index where deleted_at IS NULL']
  }
}

Table auth_sessions {
  id uuid [pk, not null, default: `uuid_generate_v4()`]
  user_id uuid [not null]
  refresh_token_hash text [not null]
  user_agent text
  ip_address text
  expires_at timestamptz [not null]
  revoked_at timestamptz
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]

  indexes {
    (refresh_token_hash) [name: 'idx_auth_sessions_refresh_token_hash', unique]
    (user_id) [name: 'idx_auth_sessions_user_id']
    (expires_at) [name: 'idx_auth_sessions_expires_at']
    (revoked_at) [name: 'idx_auth_sessions_revoked_at']
  }
}

Table email_verifications {
  id uuid [pk, not null, default: `uuid_generate_v4()`]
  user_id uuid [not null]
  email text [not null]
  code_hash text [not null]
  expires_at timestamptz [not null]
  verified_at timestamptz
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]

  indexes {
    (user_id) [name: 'idx_email_verifications_user_id']
    (email) [name: 'idx_email_verifications_email']
    (code_hash) [name: 'idx_email_verifications_code_hash']
  }
}

Table casbin_rule {
  id serial [pk, not null]
  ptype varchar(255) [not null]
  v0 varchar(255)
  v1 varchar(255)
  v2 varchar(255)
  v3 varchar(255)
  v4 varchar(255)
  v5 varchar(255)

  indexes {
    (ptype) [name: 'idx_casbin_rule_ptype']
  }
}

Table user_preferences {
  user_id uuid [pk, not null]
  reading_mode reading_mode [not null, default: 'normal']
  zen_restore_on_open boolean [not null, default: true]
  theme_mode theme_mode [not null, default: 'dark']
  theme_overrides jsonb [not null, default: `'{}'::jsonb`]
  typography_profile typography_profile [not null, default: 'comfortable']
  row_version bigint [not null, default: 1]
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]

  Note: 'Custom theme overrides are stored as token->value pairs in JSON. App/migration validation must enforce allowlisted keys (for example: background, text, accent, progress) and valid color formats.'
}

Table user_reader_state {
  user_id uuid [pk, not null]
  current_ebook_id uuid
  current_location text
  reading_mode reading_mode [not null, default: 'normal']
  row_version bigint [not null, default: 1]
  last_opened_at timestamptz
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]
}

Table ebooks {
  id uuid [pk, not null, default: `uuid_generate_v4()`]
  owner_user_id uuid [not null]
  title text [not null]
  description text
  format ebook_format [not null]
  language_code varchar(16)
  storage_key text [not null, unique]
  file_size_bytes bigint [not null]
  checksum_sha256 varchar(64) [not null]
  imported_at timestamptz [not null, default: `now()`]
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]
  deleted_at timestamptz

  indexes {
    (owner_user_id, created_at) [name: 'idx_ebooks_owner_created_at_desc', note: 'created_at DESC in SQL migration']
    (format) [name: 'idx_ebooks_format']
    (owner_user_id, id) [name: 'uq_ebooks_owner_id', unique]
  }
}

Table authors {
  id uuid [pk, not null, default: `uuid_generate_v4()`]
  name text [not null]
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]
  deleted_at timestamptz

  indexes {
    (name) [name: 'idx_authors_name_active', unique, note: 'Partial unique index where deleted_at IS NULL']
  }
}

Table ebook_authors {
  ebook_id uuid [not null]
  author_id uuid [not null]

  indexes {
    (ebook_id, author_id) [pk]
    (author_id, ebook_id) [name: 'idx_ebook_authors_author_ebook']
  }
}

Table tags {
  id uuid [pk, not null, default: `uuid_generate_v4()`]
  name text [not null]
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]
  deleted_at timestamptz

  indexes {
    (name) [name: 'idx_tags_name_active', unique, note: 'Partial unique index where deleted_at IS NULL']
  }
}

Table ebook_tags {
  ebook_id uuid [not null]
  tag_id uuid [not null]

  indexes {
    (ebook_id, tag_id) [pk]
    (tag_id, ebook_id) [name: 'idx_ebook_tags_tag_ebook']
  }
}

Table ebook_google_metadata {
  ebook_id uuid [pk, not null]
  google_books_id text [not null]
  isbn_10 varchar(10)
  isbn_13 varchar(13)
  publisher text
  published_date text
  page_count int
  categories jsonb
  thumbnail_url text
  info_link text
  raw_payload jsonb
  attached_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]
  deleted_at timestamptz

  Note: 'MVP keeps one current metadata attachment per ebook. Attach/detach is implemented as upsert + soft-delete/undelete, not historical version inserts.'
}

Table reading_progress {
  id uuid [pk, not null, default: `uuid_generate_v4()`]
  user_id uuid [not null]
  ebook_id uuid [not null]
  location text [not null]
  progress_percent numeric(5,2)
  reading_mode reading_mode [not null]
  row_version bigint [not null, default: 1]
  last_read_at timestamptz
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]
  deleted_at timestamptz

  indexes {
    (user_id, ebook_id) [name: 'uq_reading_progress_user_ebook_active', unique, note: 'Partial unique index in SQL: WHERE deleted_at IS NULL']
  }

  Note: 'Add SQL CHECK in migration: progress_percent >= 0 AND progress_percent <= 100'
}

Table bookmarks {
  id uuid [pk, not null, default: `uuid_generate_v4()`]
  user_id uuid [not null]
  ebook_id uuid [not null]
  location text [not null]
  label text
  row_version bigint [not null, default: 1]
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]
  deleted_at timestamptz

  indexes {
    (user_id, ebook_id, location) [name: 'uq_bookmarks_user_ebook_location_active', unique, note: 'Partial unique index in SQL: WHERE deleted_at IS NULL']
  }
}

Table annotations {
  id uuid [pk, not null, default: `uuid_generate_v4()`]
  user_id uuid [not null]
  ebook_id uuid [not null]
  location_start text [not null]
  location_end text [not null]
  highlight_text text
  note text
  color varchar(32)
  row_version bigint [not null, default: 1]
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]
  deleted_at timestamptz
}

Table shares {
  id uuid [pk, not null, default: `uuid_generate_v4()`]
  ebook_id uuid [not null]
  owner_user_id uuid [not null]
  title_override text
  description text
  visibility share_visibility [not null, default: 'public']
  status share_status [not null, default: 'active']
  borrow_duration_hours int [not null]
  max_concurrent_borrows int [not null, default: 1]
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]
  deleted_at timestamptz

  indexes {
    (status, visibility, created_at) [name: 'idx_shares_status_visibility_created_at_desc', note: 'created_at DESC in SQL migration']
  }

  Note: 'Add SQL CHECKs in migration: borrow_duration_hours > 0 and max_concurrent_borrows > 0'
}

Table borrows {
  id uuid [pk, not null, default: `uuid_generate_v4()`]
  share_id uuid [not null]
  borrower_user_id uuid [not null]
  started_at timestamptz [not null]
  due_at timestamptz [not null]
  returned_at timestamptz
  expired_at timestamptz
  status borrow_status [not null]
  legal_acknowledged_at timestamptz [not null]
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]

  indexes {
    (borrower_user_id, status, due_at) [name: 'idx_borrows_borrower_status_due_at']
    (share_id, borrower_user_id) [name: 'uq_borrows_share_borrower_active', unique, note: "Partial unique index in SQL: WHERE status = 'active'"]
    (status, due_at) [name: 'idx_borrows_active_due_at', note: "Partial index in SQL: WHERE status = 'active'"]
  }

  Note: 'Add SQL CHECKs in migration: due_at >= started_at; returned_at >= started_at when returned_at IS NOT NULL; expired_at >= due_at when expired_at IS NOT NULL.'
  Note: 'Add trigger/constraint logic in migration to prevent borrower from being share owner.'
}

Table share_reviews {
  id uuid [pk, not null, default: `uuid_generate_v4()`]
  share_id uuid [not null]
  user_id uuid [not null]
  rating smallint [not null]
  review_text text
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]
  deleted_at timestamptz

  indexes {
    (share_id, created_at) [name: 'idx_share_reviews_share_created_at_desc', note: 'created_at DESC in SQL migration']
    (share_id, user_id) [name: 'uq_share_reviews_share_user_active', unique, note: 'Partial unique index in SQL: WHERE deleted_at IS NULL']
  }

  Note: 'Add SQL CHECK in migration: rating >= 1 AND rating <= 5'
}

Table share_reports {
  id uuid [pk, not null, default: `uuid_generate_v4()`]
  share_id uuid [not null]
  reporter_user_id uuid [not null]
  reason report_reason [not null]
  details text
  status report_status [not null, default: 'open']
  reviewed_by_user_id uuid
  reviewed_at timestamptz
  resolution_note text
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]

  indexes {
    (status, created_at) [name: 'idx_share_reports_status_created_at_desc', note: 'created_at DESC in SQL migration']
  }
}

Table sync_events {
  id uuid [pk, not null, default: `uuid_generate_v4()`]
  user_id uuid [not null]
  entity_type sync_entity_type [not null]
  entity_id uuid [not null]
  operation sync_operation [not null]
  payload jsonb
  base_version bigint
  client_timestamp timestamptz [not null]
  server_timestamp timestamptz [not null, default: `now()`]
  idempotency_key text [not null]
  created_at timestamptz [not null, default: `now()`]

  indexes {
    (user_id, idempotency_key) [name: 'uq_sync_events_user_idempotency_key', unique]
    (user_id, server_timestamp) [name: 'idx_sync_events_user_server_timestamp_asc', note: 'server_timestamp ASC in SQL migration']
    (user_id, id) [name: 'uq_sync_events_user_id_event_id', unique]
  }
}

Table sync_checkpoints {
  user_id uuid [pk, not null]
  last_server_timestamp timestamptz [not null]
  last_event_id uuid
  updated_at timestamptz [not null, default: `now()`]
}

Ref: auth_sessions.user_id > users.id [delete: cascade]
Ref: email_verifications.user_id > users.id [delete: cascade]

Ref: user_preferences.user_id > users.id [delete: cascade]
Ref: user_reader_state.user_id > users.id [delete: cascade]
Ref: user_reader_state.current_ebook_id > ebooks.id

Ref: ebooks.owner_user_id > users.id [delete: cascade]
Ref: ebook_authors.ebook_id > ebooks.id [delete: cascade]
Ref: ebook_authors.author_id > authors.id [delete: cascade]
Ref: ebook_tags.ebook_id > ebooks.id [delete: cascade]
Ref: ebook_tags.tag_id > tags.id [delete: cascade]
Ref: ebook_google_metadata.ebook_id > ebooks.id [delete: cascade]

Ref: reading_progress.user_id > users.id [delete: cascade]
Ref: reading_progress.ebook_id > ebooks.id [delete: cascade]
Ref: bookmarks.user_id > users.id [delete: cascade]
Ref: bookmarks.ebook_id > ebooks.id [delete: cascade]
Ref: annotations.user_id > users.id [delete: cascade]
Ref: annotations.ebook_id > ebooks.id [delete: cascade]

Ref: shares.ebook_id > ebooks.id [delete: cascade]
Ref: shares.owner_user_id > users.id [delete: cascade]
Ref: shares.(owner_user_id, ebook_id) > ebooks.(owner_user_id, id) [delete: cascade]
Ref: borrows.share_id > shares.id [delete: cascade]
Ref: borrows.borrower_user_id > users.id [delete: cascade]
Ref: share_reviews.share_id > shares.id [delete: cascade]
Ref: share_reviews.user_id > users.id [delete: cascade]
Ref: share_reports.share_id > shares.id [delete: cascade]
Ref: share_reports.reporter_user_id > users.id [delete: cascade]
Ref: share_reports.reviewed_by_user_id > users.id

Ref: sync_events.user_id > users.id [delete: cascade]
Ref: sync_checkpoints.user_id > users.id [delete: cascade]
Ref: sync_checkpoints.(user_id, last_event_id) > sync_events.(user_id, id)

Note: 'Soft delete scope: users, ebooks, authors, tags, ebook_google_metadata, reading_progress, bookmarks, annotations, shares, share_reviews. Default reads should filter deleted_at IS NULL.' 
Note: 'Optional Postgres optimization: add trigram/full-text indexes for title/author/tag search in SQL migrations (e.g., pg_trgm + GIN).' 
Note: 'Sync conflict policy in migrations/services: LWW for user_preferences (including reading/customization fields) and user_reader_state; optimistic row_version checks for reading_progress, bookmarks, and annotations.'
Note: 'Reports are retained in normal operations but may be removed by explicit hard purge flows.'
